#!/bin/bash

progname=$(basename $0)
certdir=$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )
server="docs.nesi.org.nz"

ok=0
warning=1
critical=2
unknown=3

type module 1>/dev/null 2>/dev/null
if [ $? -ne 0 ]
then
	modulecmd_exe=$(which modulecmd)
	if [ $? -ne 0 ]
	then
		echo "$progname: error: neither Lmod nor Environment Modules could be detected" 1>&2
		exit $critical
	else
		function module () 
		{ 
			eval `"${modulecmd_exe}" bash $*`
		}
	fi
fi

long_hostname=$(hostname)
case ${long_hostname} in
	login-01.uoa.nesi.org.nz)
		machine="pan"
		;;
	nesi1)
		machine="fitzroy"
		export http_proxy="http://www-proxy.niwa.co.nz:80"
		export https_proxy="https://www-proxy.niwa.co.nz:80"
		;;
	p1n14-c)
		machine="kerr"
		;;	
	p2n14-c)
		machine="beatrice"
		;;
	bpfen1)
		machine="foster"
		;;
	viz0)
		machine="popper"
		;;
	*)
		echo "${progname}: error: unknown hostname: ${long_hostname}" 1>&2
		exit $critical
		;;
esac

echo "Testing connection to documentation server ..."
curl --cacert ${certdir}/docs.pem --cert ${certdir}/${machine}.pem --key ${certdir}/${machine}.key https://${server}:443/${machine} > /dev/null
curl_status=$?
if [ ${curl_status} -ne 0 ]
then
	echo "${progname}: error: unable to connect to documentation server" 1>&2
	exit $critical
fi

home_dir=$(eval echo ~)
output_file="${home_dir}/modules-$$.txt"

rm -rf "${output_file}"

badmods=( )

echo "Generating module list ..."
for mod in $(module avail -t 2>&1 | grep -v ':$')
do
	print_this_module=true
	for badmod in ${badmods[*]}
	do
		if [ "${mod}" == "${badmod}" ]
		then
			print_this_module=false
			break
		fi
	done
	if [ "${print_this_module}" == "true" ]
	then	
		module whatis $mod 2>&1
	fi
done | \
	sed -e 's/:\s\+Description:/:/' | \
	grep ': ' | \
	grep -v ":ERROR:" | \
	grep -Ev "[Nn]ot (supported|available)" | \
	grep -v "only available" | \
	sed -e '/^\s*$/d' \
	> "${output_file}"
echo "Uploading module list ..."
curl --cacert ${certdir}/docs.pem --cert ${certdir}/${machine}.pem --key ${certdir}/${machine}.key https://docs.nesi.org.nz:443/${machine} -F myfile=@${output_file}
echo "Cleaning up ..."
rm ${output_file}
echo "Done."
exit $ok
